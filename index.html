<!DOCTYPE html>
<html>
  <style>
    html, body {height: 100%}
    aside {height: 98%}
    p {margin-left: 2em}
    button {line-height: 2em}
  </style>

  <aside style='position: absolute; width: 15em; background-color: #CCC'>
    <h1>Rhumba</h1>
    <p>
      <button onclick="prev()">&#x2590;&#x25C0;&#xA0;</button>
      <button onclick="pause()">&#x258C;&#x258C;</button>
      <button onclick="next()">&#x25B6;&#x258C;</button>
      <button onclick="play()">&#xA0;&#x25B6;&#xA0;</button>
    </p>
    <h2></h2>
    <p id="count"></p>
    <p id="text"></p>
    <p id="note"></p>
  </aside>

  <svg width="1024" height="768" xmlns="http://www.w3.org/2000/svg">
    <path id="leader-path" stroke="#999" fill="none"/>
    <path id="follower-path" stroke="#C77" fill="none"/>

    <g id="follower">
      <g class="right">
	<g>
	  <path d="M8,9c8,-11,5-29,1-48c-2-11-10-11-15-0
            c-10,17-17,23-7,45c5,9,20,6,21,3">
	    <animate class="ball" attributeName="fill" fill="freeze"/>
	  </path>
	  <path d="M-8,40c1,5-13,16-10-3z">
	    <animate class="heel" attributeName="fill" fill="freeze"/>
	  </path>
	  <animateTransform attributeName="transform" type="rotate"
	    fill="freeze"/>
	</g>
	<animateMotion fill="freeze"/>
      </g>

      <g class="left">
	<g>
	  <path d="M-8,9c-8-11-5-29-1-48c2-11,10-11,15,0
            c10,17,17,23,7,45c-5,9-20,6-21,3">
	    <animate class="ball" attributeName="fill" fill="freeze"/>
	  </path>
          <path d="M8,40c-1,5,13,16,10-3z">
	    <animate class="heel" attributeName="fill" fill="freeze"/>
	  </path>
	  <animateTransform attributeName="transform" type="rotate"
	    fill="freeze"/>
	</g>
	<animateMotion fill="freeze"/>
      </g>
    </g>

<!--
    <g transform="translate(577,204) rotate(180)">
      <path d="M0,0l0-100" stroke="#000" fill="none"/>
      <g transform="translate(0,-100) rotate(0)">
        <path d="M0,0c100,0,200,100,200,200" stroke="#000" fill="none"/>
        <g transform="translate(200,200) rotate(135)">
          <path d="M0,0c32,0,160,120,72,212" stroke="#000" fill="none"/>
        </g>
      </g>
    </g>
    <path d="M577,204v100c-100,0,-200-100,-200-200c100-50,200,0,200,100" stroke="#F00" fill="none"/>
    <g transform="translate(577,204) rotate(180)">
      <path d="M0,0l0-100" stroke="#0F0" fill="none"/>
      <g transform="translate(0,-100) rotate(45)">
        <path d="M0,0c70.711,-70.711,212.132,-70.711,282.843,0.0" stroke="#0F0" fill="none"/>
        <g transform="translate(282.843,0.0) rotate(135)">
          <path d="M0,0c100.0,-50.0,200.0,0.0,200.0,100.0" stroke="#0F0" fill="none"/>
        </g>
      </g>
    </g>

    <g transform="translate(507,204) rotate(180)">
      <path d="M0,0l30-30" stroke="#000" fill="none"/>
      <g transform="translate(30,-30) rotate(90)">
        <path d="M0,0l30,0" stroke="#000" fill="none"/>
        <g transform="translate(30,0) rotate(270)">
          <path d="M0,0l-30,0" stroke="#000" fill="none"/>
        </g>
      </g>
    </g>
-->

    <g id="leader">
      <g class="left">
	<g>
          <path d="M-8,9c-10-20-10-34,0-49c7-10,16-11,21,0c10,27,6,26,1,43z">
	    <animate class="ball" attributeName="fill" fill="freeze">
	  </path>
          <path d="M-3,29c-6,26,38,28,21-4z">
	    <animate class="heel" attributeName="fill" fill="freeze">
	  </path>
	  <animateTransform attributeName="transform" type="rotate"
	    fill="freeze"/>
	</g>
	<animateMotion fill="freeze"/>
      </g>

      <g class="right">
	<g>
          <path d="M8,9c10-20,10-34,0-49c-7-10-16-11-21,0c-10,27-6,26-1,43z">
	    <animate class="ball" attributeName="fill" fill="freeze">
	  </path>
          <path d="M3,29c6,26-38,28-21-4z">
	    <animate class="heel" attributeName="fill" fill="freeze">
	  </path>
	  <animateTransform attributeName="transform" type="rotate"
	    fill="freeze"/>
	</g>
	<animateMotion fill="freeze"/>
      </g>
    </g>
  </svg>

  <script>
    var clock = 0;
    var paused = false;
    var advance = false;
    var direction = +1;

    function pause() {
      paused = true;
    }

    function play() {
      paused = false;
      direction = +1;
    }

    function next() {
      if (!paused) return;
      advance = 2;
      direction = +1;
    }

    function prev() {
      if (!paused) return;
      advance = 2;
      clock--;
      direction = -1;
    }

    var initial = {
      follower: {
        color: "#9B111E",

	right: {
	  x: 607,
	  y: 304,
          rotate: 180
	},

	left: {
	  x: 677,
	  y: 304,
          rotate: 180
	}
      },

      leader: {
        color: "#000",

	left: {
	  x: 587,
	  y: 434,
          rotate: 0
	},

	right: {
	  x: 657,
	  y: 434,
          rotate: 0
	}
      }
    };

    var steps = [{
      count: 1,
      time: 2,
      text: 'slow',
      leader: {left: 'forward'},
      follower: {right: 'back'}
    }, {
      time: -0.25,
      leader: {left: {heel: 'down'}, right: {heel: 'up'}},
      follower: {right: {heel: 'down'}, left: {heel: 'up'}}
    },{
      time: 1,
      text: 'quick ...',
      leader: {right: {path: 'c0,-90,10,-100,100-100'}},
      follower: {left: {path: 'c0,90,-10,100-100,100'}}
    }, {
      time: -0.25,
      leader: {right: {heel: "down"}, left: {heel: "up"}},
      follower: {left: {heel: "down"}, right: {heel: "up"}}
    }, {
      time: 1,
      text: '... quick',
      leader: {left: {path: 'h100'}},
      follower: {right: {path: 'h-100'}}
    }, {
      time: -0.25,
      leader: {left: {heel: "down"}, right: {heel: "up"}},
      follower: {right: {heel: "down"}, left: {heel: "up"}}
    }, {
      time: 2,
      text: 'slow',
      leader: {right: 'back'},
      follower: {left: 'forward'}
    }, {
      time: -0.25,
      leader: {right: {heel: "down"}, left: {heel: "up"}},
      follower: {right: {heel: "up"}, left: {heel: "down"}}
    },{
      time: 1,
      text: 'quick ...',
      note: 'leader raises left hand',
      leader: {left: {path: 'c0,90,-10,100,-100,100'}},
      follower: {right: {path: 'l50-20', rotate: 90}, left: {rotate: 45}}
    }, {
      time: -0.25,
      leader: {left: {heel: "down"}},
      follower: {left: {heel: "up"}}
    }, {
      time: 1,
      text: '... quick',
      note: 'follower passes under arms',
      leader: {right: {path: 'h-100'}},
      follower: {
        left: {
          position: {path: 'c106.066,-106.066,141.421,-141.421,282.843,0.0'},
          rotate: 135
        },
        right: {rotate: 90}
      }
    }, {
      time: -0.25,
      leader: {right: {heel: "down"}, left: {heel: "up"}},
      follower: {left: {heel: "down"}}
    }, {
      time: 2,
      text: 'slow',
      leader: {left: 'forward'},
      follower: {right: {path: 'l0-50', rotate: 180}}
    }, {
      time: -0.25,
      leader: {left: {heel: 'down'}, right: {heel: 'up'}},
      follower: {left: {heel: 'up'}}
    },{
      time: 1,
      text: 'quick ...',
      leader: {right: {path: 'c0,-90,10,-100,100-100'}},
      follower: {left: {
        path: 'c100.0,-50.0,200.0,0.0,200.0,100.0',
        rotate: 180
      }}
    }, {
      time: -0.25,
      leader: {right: {heel: "down"}, left: {heel: "up"}},
      follower: {left: {heel: "down"}}
    }, {
      time: 1,
      text: '... quick',
      leader: {left: {path: 'h100'}},
      follower: {right: {path: 'l-50-30'}}
    }, {
      time: -0.25,
      leader: {left: {heel: "down"}, right: {heel: "up"}},
      follower: {left: {heel: "up"}, right: {heel: "down"}}
    }, {
      time: 2,
      text: 'slow',
      leader: {right: 'back'},
      follower: {left: 'forward'}
    }, {
      time: -0.25,
      leader: {right: {heel: "down"}, left: {heel: "up"}},
      follower: {left: {heel: "down"}, right: {heel: "up"}}
    },{
      time: 1,
      text: 'quick ...',
      leader: {left: {path: 'c0,90,-10,100,-100,100'}},
      follower: {right: {path: 'c0-90,10-100,100-100'}}
    }, {
      time: -0.25,
      leader: {left: {heel: "down"}, right: {heel: "up"}},
      follower: {right: {heel: "down"}, left: {heel: "up"}}
    }, {
      time: 1,
      text: '... quick',
      leader: {right: {path: 'h-100'}},
      follower: {left: {path: 'h100'}}
    }, {
      time: -0.25,
      leader: {right: {heel: "down"}, left: {heel: "up"}},
      follower: {left: {heel: "down"}, right: {heel: "up"}}
    }];


    function clone(object) {
      return JSON.parse(JSON.stringify(object));
    }

   function merge(destination, source) {
     for (var property in source) {
       if (typeof source[property] === "object") {
         destination[property] = destination[property] || {};
         merge(destination[property], source[property]);
       } else {
         destination[property] = source[property];
       }
     }
     return destination;
   };

    var shoes = clone(initial);

    // "compile" script
    var count = 0;
    var routine = []
    while (steps.length > 0) {
      step = steps.shift();

      // optionally reset count
      if (step.count) count = step.count;

      // find step (adding to routine as needed)
      if (step.time < 0) {
        step.time = -step.time;
      } else {
        var ops = step;
        for (var i=0; i<step.time*4; i++) {
          if (count && routine.length % 4 == 0) {
            ops.count = count++;
          }
          routine.push(ops);
          ops = {}
        }
      }
      merge(routine[routine.length-step.time*4], step);

      // compile steps
      ["leader", "follower"].forEach(function(person) {
        if (!step[person]) return;
        ["left", "right"].forEach(function(foot) {
          var ops = step[person][foot];
          if (!ops) return;

          // aliases for movement
          if (ops == 'forward') ops = step[person][foot] = {path: 'v-100'}
          if (ops == 'back') ops = step[person][foot] = {path: 'v100'}

          // shorthand for position.path
          if (ops.path && !ops.position) {
            ops.position = {path: ops.path};
            delete ops.path;
          }

          // shorthand for orientation.rotate
          if (ops.rotate && !ops.orientation) {
            ops.orientation = {rotate: ops.rotate};
            delete ops.rotate;
          }

          ops.forward = {};
          ops.reverse = {};

          ["position", "orientation", "ball", "heel"].forEach(function(attr) {
            // aliases for raising/lowering
            if (ops[attr] == 'up') {
              ops[attr] = {from: shoes[person].color, to: '#FFF'};
            } else if (ops[attr] == 'down') {
              ops[attr] = {to: shoes[person].color, from: '#FFF'};
            }

            op = ops[attr];
            if (!op) return;
            ops.forward[attr] = op;

            if (step.time) op.dur = Math.abs(step.time) + 's';

            // apply rotation
            if (op.rotate) {
              var shoe = shoes[person][foot];
              op.from = shoe.rotate; 
              op.to = shoe.rotate + op.rotate;
              shoe.rotate += op.rotate;
            }

            // construct reverse
            var last = routine[routine.length-1];
            if (!last[person]) last[person] = {};
            if (!last[person][foot]) last[person][foot] = {};
            if (!last[person][foot].reverse) last[person][foot].reverse = {};
            var reverse = last[person][foot].reverse;
            reverse[attr] = clone(op); 
            if (op.from && op.to) {
              reverse[attr].from = op.to;
              reverse[attr].to = op.from;
            }

            if (op.path) {
              // parse path
              var result = []
              var index = 0;
              while (index < op.path.length) {
                var match = op.path.slice(index).
                  match(/[ ,]*([a-zA-Z]|[+-]?\d+\.?\d*)/);
                if (match[1].match(/^[-\d]/)) {
                  result.push(parseFloat(match[1]));
                } else {
                  result.push(match[1]);
                }
                index += match[0].length;
              }

              // normalize paths
              for (var i=result.length-1; i>=0; i--) {
                if (result[i] == 'v') {
                  result.splice(i+1, 0, 0);
                  result[i] = 'l';
                } else if (result[i] == 'h') {
                  result.splice(i+2, 0, 0);
                  result[i] = 'l';
                }
              }

              // determine rotation
              var angle = shoes[person][foot].rotate % 360;
              if (angle < 0) angle += 360;
              var sin, cos;
              if (angle < 180) {
                var radians = angle/180*Math.PI
                sin = Math.sin(radians)
                cos = Math.cos(radians)
              } else {
                var radians = (angle-180)/180*Math.PI
                sin = -Math.sin(radians)
                cos = -Math.cos(radians)
              }

              // perform rotation
              for (var i=result.length-1; i>0; i--) {
                if (typeof(result[i])=="number") {
                  if (typeof(result[i-1])=="number") {
                    var x = result[i-1]*cos - result[i]*sin;
                    var y = result[i]*cos + result[i-1]*sin;
                    result[i-1] = x;
                    result[i] = y;
                    i--;
                  }
                }
              }

              // extract, normalize offset
              var offset = result.slice(-2);
              if (result[0] == 'M') result = result.slice(3)

              // construct reverse
              rpath = clone(result);
              for (var i=0; i<rpath.length; i++) {
                if (rpath[i] == "c") {
                  [].splice.apply(rpath,
                    [i+3,0].concat(rpath.splice(i+1,2)))
                  for (var j=1; j<5; j++) {
                    rpath[i+j] = rpath[i + 6 - j%2] - rpath[i+j]
                  }
                } else if (typeof(rpath[i]) == "number") {
                  rpath[i] = -rpath[i];
                }
              }

              // insert move commands
              result.unshift('M', shoes[person][foot].x, shoes[person][foot].y);
              shoes[person][foot].x += offset[0];
              shoes[person][foot].y += offset[1];
              rpath.unshift('M', shoes[person][foot].x, shoes[person][foot].y);
              
              // serialize result, rpath
              for (var i=result.length-1; i>0; i--) {
                if (typeof(result[i])=="number") {
                  if (typeof(result[i-1])=="number") {
                    result[i] = ',' + result[i];
                    rpath[i] = ',' + rpath[i];
                  } else {
                    result[i] = result[i].toString();
                    rpath[i] = rpath[i].toString();
                  }
                }
              }
              op.path = result.join('');
              reverse[attr].path = rpath.join('');
            }
          });
        });
      });
    }

    // apply initial settings
    shoes = initial;

    ["leader", "follower"].forEach(function(person) {
      var node = document.getElementById(person);
      ["left", "right"].forEach(function(side) {
	var shoe = shoes[person][side];
        var color = shoes[person].color;
	shoe.node = node.getElementsByClassName(side)[0];
	shoe.position = shoe.node.getElementsByTagName("animateMotion")[0];
        shoe.position.setAttribute('path', "M0,0L" + shoe.x + ',' + shoe.y);
        shoe.position.setAttribute('dur', '0.01s');
	shoe.orientation = shoe.node.getElementsByTagName("animateTransform")[0]; 
        shoe.orientation.setAttribute('from', '0');
        shoe.orientation.setAttribute('to', shoe.rotate);
        shoe.orientation.setAttribute('dur', '0.01s');
	shoe.ball = {}
	shoe.ball.node = shoe.node.querySelector("animate.ball");
        shoe.ball.node.parentNode.setAttribute("fill", color);
        shoe.ball.node.parentNode.setAttribute("stroke", color);
	shoe.heel = {}
	shoe.heel.node = shoe.node.querySelector("animate.heel");
        shoe.heel.node.parentNode.setAttribute("fill", color);
        shoe.heel.node.parentNode.setAttribute("stroke", color);
      });
    });

    shoes.leader.left.heel.node.parentNode.setAttribute("fill", "#FFF");
    shoes.follower.right.heel.node.parentNode.setAttribute("fill", "#FFF");

    // capture paths
    var path = {
      leader: document.getElementById('leader-path'),
      follower: document.getElementById('follower-path')
    }

    // capture aside targets
    var aside = {
      count: document.getElementById('count'),
      text: document.getElementById('text'),
      note: document.getElementById('note'),
    }

    // dance
    setInterval(function() {
      if (paused && !advance) return;

      step = routine[clock];

      if (!step) {
        aside.text.textContent = '';
        aside.note.textContent = '';
        path.leader.setAttribute('d', 'M0,0');
        path.follower.setAttribute('d', 'M0,0');
        paused = true;
        return;
      }

      clock += direction;

      if (advance && step.count && (step.leader || step.follower)) {
        if (advance == 1) {
          advance = false;
          clock -= direction;
          return;
        } else if (advance == 2) {
          if (direction == -1) {
            advance = false;
            clock++;
          } else {
            advance--;
          }
        }
      }

      if (step.count) {
        aside.count.textContent = 'count: ' + step.count;
      }

      for (var attr in step) {
        if (attr == 'text') {
          aside.text.textContent = step.text;
          aside.note.textContent = '';
        } if (attr == 'note') {
          aside.note.textContent = step.note;
        } else if (shoes[attr]) {
          var person = attr;
	  for (var foot in step[person]) {
	    shoe = shoes[person][foot];
	    op = step[person][foot];
            op = (direction == -1 ? op.reverse : op.forward);
            if (!op) continue;
	    if (op.position) {
              if (op.position.path) {
                path[person].setAttribute('d', op.position.path);
              }
	      for (var attr in op.position) {
		shoe.position.setAttribute(attr, op.position[attr]);
	      }
	      shoe.position.beginElement();
	    }
	    if (op.orientation) {
	      for (var attr in op.orientation) {
		shoe.orientation.setAttribute(attr, op.orientation[attr]);
	      }
	      shoe.orientation.beginElement();
	    }
	    if (op.heel) {
	      for (var attr in op.heel) {
		shoe.heel.node.setAttribute(attr, op.heel[attr]);
	      }
	      shoe.heel.node.beginElement();
	    }
	  }
	}
      }
    }, 250);
  </script>
</html>
